<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourPlanner Debug Panel</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç TourPlanner Debug Panel</h1>
            <div class="subtitle">Panel diagnostyczny API</div>
        </div>

        <div class="content">
            <div class="debug-section">
                <h3>‚öôÔ∏è Konfiguracja</h3>
                <div class="form-group">
                    <label>Bearer Token:</label>
                    <input type="password" id="token" placeholder="Wklej token z aplikacji">
                </div>
                <div class="form-group">
                    <label>Proxy URL:</label>
                    <input type="url" id="proxyUrl" placeholder="http://localhost:5000">
                </div>
                <div class="form-group">
                    <label>Direct API URL:</label>
                    <input type="url" id="directUrl" value="https://api2.tourplanner.tdy-apps.com" readonly>
                </div>
            </div>

            <div class="debug-section">
                <h3>ü©∫ Testy diagnostyczne</h3>
                <button onclick="testProxyHealth()" class="btn btn-primary">1. Test Health Proxy</button>
                <button onclick="testDirectAPI()" class="btn btn-secondary">2. Test Direct API (CORS)</button>
                <button onclick="testProxyAPI()" class="btn btn-primary">3. Test Proxy API</button>
                <button onclick="compareRequests()" class="btn btn-warning">4. Por√≥wnaj zapytania</button>
                <button onclick="clearResults()" class="btn btn-secondary">üóëÔ∏è Wyczy≈õƒá wyniki</button>
                
                <div id="results"></div>
            </div>

            <div class="debug-section">
                <h3>üìä Analiza Network</h3>
                <p>Otw√≥rz DevTools (F12) ‚Üí Network tab i wykonaj testy powy≈ºej aby zobaczyƒá szczeg√≥≈Çy zapyta≈Ñ HTTP</p>
                <button onclick="showNetworkInstructions()" class="btn btn-warning">üìñ Instrukcje debugowania</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <a href="/" class="btn btn-primary">‚Üê Powr√≥t do aplikacji</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect proxy URL
        document.getElementById('proxyUrl').value = window.location.origin;
        
        function addResult(title, content, type = 'result') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `<h4>${title}</h4><div class="result ${type}">${content}</div>`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testProxyHealth() {
            const proxyUrl = document.getElementById('proxyUrl').value;
            
            try {
                addResult('üè• Test Health Proxy', 'Sprawdzanie czy proxy server dzia≈Ça...');
                
                const response = await fetch(`${proxyUrl}/health`);
                const result = await response.text();
                
                if (response.ok) {
                    addResult('‚úÖ Proxy Health OK', `Status: ${response.status}\nResponse: ${result}`, 'success');
                } else {
                    addResult('‚ùå Proxy Health Error', `Status: ${response.status}\nResponse: ${result}`, 'error');
                }
            } catch (error) {
                addResult('‚ùå Proxy Health Error', `Nie mo≈ºna po≈ÇƒÖczyƒá z proxy:\n${error.message}\n\nSprawd≈∫ czy serwer dzia≈Ça na ${proxyUrl}`, 'error');
            }
        }

        async function testDirectAPI() {
            const token = document.getElementById('token').value;
            const directUrl = document.getElementById('directUrl').value;
            
            try {
                addResult('üåê Test Direct API', 'Pr√≥ba bezpo≈õredniego po≈ÇƒÖczenia (spodziewany b≈ÇƒÖd CORS)...');
                
                const response = await fetch(`${directUrl}/territory/list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pagination: { page: 0, pageSize: 1 }
                    })
                });
                
                const result = await response.text();
                addResult('ü§î Direct API Response', `Status: ${response.status}\nResponse: ${result}`, response.ok ? 'success' : 'warning');
                
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult('‚úÖ CORS Error (oczekiwany)', `B≈ÇƒÖd CORS potwierdza, ≈ºe potrzebujemy proxy:\n${error.message}`, 'warning');
                } else {
                    addResult('‚ùå Direct API Error', error.message, 'error');
                }
            }
        }

        async function testProxyAPI() {
            const token = document.getElementById('token').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            
            if (!token) {
                addResult('‚ùå Error', 'Najpierw wprowad≈∫ Bearer token', 'error');
                return;
            }
            
            // Test r√≥≈ºnych endpoint√≥w
            const endpoints = [
                'territory/list',
                'territories/list', 
                'territory',
                'territories'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    addResult(`üîÑ Test Proxy API: ${endpoint}`, `Testowanie endpoint: ${endpoint}...`);
                    
                    const response = await fetch(`${proxyUrl}/api/tourplanner/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            pagination: { page: 0, pageSize: 1 }
                        })
                    });
                    
                    const result = await response.text();
                    
                    if (response.ok) {
                        addResult(`‚úÖ ${endpoint} - SUCCESS`, `Status: ${response.status}\nResponse: ${result}`, 'success');
                        break; // Je≈õli jeden dzia≈Ça, przesta≈Ñ testowaƒá
                    } else {
                        addResult(`‚ùå ${endpoint} - FAILED`, `Status: ${response.status}\nResponse: ${result}`, 'error');
                    }
                } catch (error) {
                    addResult(`‚ùå ${endpoint} - ERROR`, `Network error: ${error.message}`, 'error');
                }
            }
        }

        async function compareRequests() {
            addResult('üìä Por√≥wnanie zapyta≈Ñ', 'Por√≥wnujƒÖc dzia≈ÇajƒÖcy bookmarklet z PWA...');
            
            const token = document.getElementById('token').value;
            const proxyUrl = document.getElementById('proxyUrl').value;

            if (!token) {
                addResult('‚ùå Error', 'Najpierw wprowad≈∫ Bearer token', 'error');
                return;
            }

            // Test bookmarklet-style request
            try {
                const bookmarkletResult = await fetch('https://api2.tourplanner.tdy-apps.com/territory/list', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pagination: { page: 0, pageSize: 1 }
                    })
                });
                
                addResult('üìñ Bookmarklet Style', `Status: ${bookmarkletResult.status} (blocked by CORS)`, 'warning');
            } catch (error) {
                addResult('üìñ Bookmarklet Style', `CORS blocked (normalnie dzia≈Ça w bookmarklet): ${error.message}`, 'warning');
            }

            // Test PWA-style request through proxy
            try {
                const pwaResult = await fetch(`${proxyUrl}/api/tourplanner/territory/list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pagination: { page: 0, pageSize: 1 }
                    })
                });
                
                const resultText = await pwaResult.text();
                addResult('üöÄ PWA Style (przez proxy)', `Status: ${pwaResult.status}\nResponse: ${resultText}`, 
                    pwaResult.ok ? 'success' : 'error');
            } catch (error) {
                addResult('üöÄ PWA Style Error', error.message, 'error');
            }
        }

        function showNetworkInstructions() {
            addResult('üìñ Instrukcje debugowania Network', `
1. Otw√≥rz DevTools (F12)
2. Przejd≈∫ do zak≈Çadki Network
3. Wykonaj test "Test Proxy API"
4. Znajd≈∫ zapytanie do /api/tourplanner/territory/list
5. Sprawd≈∫:
   - Request URL
   - Request Headers (Authorization, Content-Type)
   - Request Body
   - Response Status
   - Response Headers
   - Response Body

Por√≥wnaj z dzia≈ÇajƒÖcym bookmarkletem w konsoli.

Typowe problemy:
- 404: B≈Çƒôdny endpoint lub proxy nie przekazuje poprawnie
- 401: B≈Çƒôdny token
- 500: B≈ÇƒÖd serwera proxy
- Connection refused: Proxy server nie dzia≈Ça
            `, 'warning');
        }

        // Auto-load saved values
        window.addEventListener('load', () => {
            const savedToken = localStorage.getItem('tp_bearer_token');
            
            if (savedToken) document.getElementById('token').value = savedToken;
        });

        // Auto-save values
        document.getElementById('token').addEventListener('input', (e) => {
            localStorage.setItem('tp_bearer_token', e.target.value);
        });
    </script>
</body>
</html>
